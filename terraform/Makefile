# AI Interviewer Terraform Makefile
.PHONY: help init plan apply destroy status clean rebuild

# Default target
help:
	@echo "AI Interviewer Infrastructure Management"
	@echo ""
	@echo "Available targets:"
	@echo "  init      - Initialize Terraform"
	@echo "  plan      - Plan infrastructure changes"
	@echo "  apply     - Apply infrastructure changes"
	@echo "  destroy   - Destroy all infrastructure"
	@echo "  status    - Check infrastructure status"
	@echo "  rebuild   - Destroy and rebuild everything"
	@echo "  clean     - Clean Terraform state and cache"
	@echo ""
	@echo "Quick commands:"
	@echo "  make init apply    - Deploy everything"
	@echo "  make rebuild       - Fresh deployment"

# Initialize Terraform
init:
	@echo "ğŸš€ Initializing Terraform..."
	terraform init
	@echo "âœ… Terraform initialized"

# Plan infrastructure changes
plan:
	@echo "ğŸ“‹ Planning infrastructure changes..."
	terraform plan -out=tfplan
	@echo "âœ… Plan complete - review above"

# Apply infrastructure changes
apply:
	@echo "ğŸ”¨ Applying infrastructure changes..."
	terraform apply -auto-approve
	@echo "âœ… Infrastructure deployed!"
	@echo ""
	@echo "ğŸŒ Application URLs:"
	@terraform output -raw application_url
	@echo "/grafana/ - Grafana Dashboard"
	@echo "/registry/ - MCP Registry"
	@echo ""
	@echo "ğŸ“Š Check status with: make status"

# Destroy all infrastructure
destroy:
	@echo "ğŸ’¥ Destroying all infrastructure..."
	@read -p "Are you sure? This will delete everything! [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		terraform destroy -auto-approve; \
		echo "âœ… Infrastructure destroyed"; \
	else \
		echo "âŒ Cancelled"; \
	fi

# Check infrastructure status
status:
	@echo "ğŸ“Š Infrastructure Status"
	@echo "========================"
	@echo "Minikube Status:"
	@minikube status || echo "âŒ Minikube not running"
	@echo ""
	@echo "Kubernetes Pods:"
	@kubectl get pods -n ai-interviewer 2>/dev/null || echo "âŒ No pods found"
	@echo ""
	@echo "Services:"
	@kubectl get services -n ai-interviewer 2>/dev/null || echo "âŒ No services found"
	@echo ""
	@echo "External Access:"
	@kubectl get service ai-interviewer-nginx-gateway -n ai-interviewer 2>/dev/null || echo "âŒ Gateway not found"

# Rebuild everything
rebuild: destroy apply

# Clean Terraform cache and state
clean:
	@echo "ğŸ§¹ Cleaning Terraform cache..."
	rm -rf .terraform/
	rm -f .terraform.lock.hcl
	rm -f tfplan
	rm -f terraform.tfstate.backup
	@echo "âœ… Terraform cache cleaned"
	@echo "âš ï¸  Note: terraform.tfstate preserved"

# Development helpers
dev-logs:
	@echo "ğŸ“‹ Showing recent logs from all pods..."
	kubectl logs -n ai-interviewer -l app.kubernetes.io/part-of=ai-interviewer --tail=100

dev-shell:
	@echo "ğŸš Opening shell in backend pod..."
	kubectl exec -n ai-interviewer -it deployment/ai-interviewer-backend -- /bin/bash

dev-port-forward:
	@echo "ğŸ”— Port forwarding backend to localhost:8080..."
	kubectl port-forward -n ai-interviewer service/ai-interviewer-backend 8080:8080

# Build Docker images before deployment
build-images:
	@echo "ğŸ³ Building Docker images..."
	cd .. && make build-all
	@echo "âœ… Docker images built"

# Full deployment with image building
deploy: build-images init apply

# Quick development cycle
dev: build-images
	@echo "ğŸ”„ Updating running deployment with new images..."
	@./scripts/update-images.sh

# Validate configuration
validate:
	@echo "âœ… Validating Terraform configuration..."
	terraform validate
	@echo "âœ… Configuration is valid"